<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TeamPlay Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root { --bg: #0b0e11; --card: #1c2127; --accent: #00d1ff; --danger: #ff4757; --text: #ffffff; --subtext: #94a3b8; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 10px 15px 120px 15px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .balance-chip { background: rgba(0, 209, 255, 0.1); padding: 8px 15px; border-radius: 20px; color: var(--accent); font-weight: bold; border: 1px solid rgba(0, 209, 255, 0.2); }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .btn { background: var(--accent); color: #000; border: none; padding: 16px; border-radius: 16px; font-weight: 800; width: 100%; cursor: pointer; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* XP BAR */
        .xp-bg { background: #111; height: 8px; border-radius: 4px; margin: 10px 0; overflow: hidden; }
        .xp-fill { background: var(--accent); height: 100%; width: 0%; transition: 0.5s; }

        /* NAV */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: #0b0e11fb; display: flex; justify-content: space-around; padding: 15px 5px 30px; border-top: 1px solid #ffffff10; backdrop-filter: blur(10px); z-index: 1000; }
        .nav-link { color: #4b5563; text-decoration: none; font-size: 10px; text-align: center; flex: 1; }
        .nav-link.active { color: var(--accent); }
        .nav-link i { display: block; font-size: 20px; font-style: normal; margin-bottom: 4px; }

        /* CASE ANIMATION */
        .roulette-box { height: 100px; background: #000; border-radius: 15px; position: relative; overflow: hidden; margin: 15px 0; border: 1px solid var(--accent); display: none; }
        .tape { display: flex; position: absolute; left: 0; height: 100%; align-items: center; transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1); }
        .p-item { min-width: 100px; text-align: center; font-size: 12px; }
    </style>
</head>
<body>

    <div class="header">
        <div><span id="h-lvl" style="color:var(--accent); font-size:12px;">LVL 1</span><br><b id="h-name">–ó–∞–≥—Ä—É–∑–∫–∞...</b></div>
        <div class="balance-chip"><span id="h-bal">0</span> ‚≠ê</div>
    </div>

    <div id="p-home" class="page active">
        <div id="home-main">
            <div class="card" onclick="openCaseMenu()" style="cursor:pointer;">
                <b style="font-size:18px;">üéÅ –ö–µ–π—Å –ü—Ä–∏–≤–∏–ª–µ–≥–∏–π</b>
                <p style="color:var(--subtext); margin:5px 0 0; font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å –∑–∞ 1000 ‚≠ê</p>
            </div>
            <div class="card">
                <p style="text-transform:uppercase; color:var(--subtext); font-size:11px; margin-bottom:10px;">–õ–µ–Ω—Ç–∞ –≤—ã–∏–≥—Ä—ã—à–µ–π</p>
                <div id="global-logs" style="font-size:12px;"></div>
            </div>
        </div>

        <div id="case-ui" style="display:none;">
            <div class="card" style="text-align:center;">
                <div id="r-box" class="roulette-box"><div id="tape" class="tape"></div></div>
                <button class="btn" id="spin-btn" onclick="startSpin()">–ö–†–£–¢–ò–¢–¨</button>
            </div>
            <button class="btn" style="background:#222; color:#fff;" onclick="closeCaseMenu()">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <div id="p-top" class="page">
        <h2>–†–µ–π—Ç–∏–Ω–≥ üèÜ</h2>
        <div id="leader-list"></div>
    </div>

    <div id="p-bonus" class="page">
        <h2>–ë–æ–Ω—É—Å—ã ‚ö°</h2>
        <div class="card">
            <b>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞</b>
            <p id="bonus-timer" style="font-size:12px; color:var(--subtext);">–î–æ—Å—Ç—É–ø–Ω–æ —Ä–∞–∑ –≤ 24 —á–∞—Å–∞</p>
            <button class="btn" id="daily-btn" onclick="claimDaily()">–ó–ê–ë–†–ê–¢–¨ 100 ‚≠ê</button>
        </div>
    </div>

    <div id="p-profile" class="page">
        <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å üë§</h2>
        <div class="card">
            <div style="display:flex; justify-content:space-between; font-size:12px;">
                <span id="prof-lvl">LVL 1</span>
                <span id="prof-xp-text">0/1000 XP</span>
            </div>
            <div class="xp-bg"><div id="xp-fill" class="xp-fill"></div></div>
            <input type="text" id="name-input" placeholder="–ù–∏–∫–Ω–µ–π–º" style="width:100%; background:#000; border:1px solid #333; color:#fff; padding:12px; border-radius:12px; margin:10px 0;">
            <button class="btn" onclick="saveName()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
        <p style="font-size:11px; color:var(--subtext); text-transform:uppercase;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</p>
        <div id="inv-list"></div>
    </div>

    <div id="p-bans" class="page">
        <h2 style="color:var(--danger)">–ë–∞–Ω-–ª–∏—Å—Ç ‚õî</h2>
        <div id="ban-list"></div>
    </div>

    <nav class="nav">
        <a href="#" class="nav-link active" onclick="showP('home', this)"><i>üè†</i>–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="#" class="nav-link" onclick="showP('top', this)"><i>üèÜ</i>–¢–û–ü</a>
        <a href="#" class="nav-link" onclick="showP('bans', this)"><i>‚õî</i>–ë–∞–Ω—ã</a>
        <a href="#" class="nav-link" onclick="showP('bonus', this)"><i>‚ö°</i>–ë–æ–Ω—É—Å—ã</a>
        <a href="#" class="nav-link" onclick="showP('profile', this)"><i>üë§</i>–ü—Ä–æ—Ñ–∏–ª—å</a>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPx6V-_sE6k1_hnOkCvR8E1wOlsabVMbc",
            authDomain: "teamplay-9f75a.firebaseapp.com",
            databaseURL: "https://teamplay-9f75a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "teamplay-9f75a",
            storageBucket: "teamplay-9f75a.firebasestorage.app",
            appId: "1:975773372092:web:0a67ef446f6c8444318ab9"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const tg = window.Telegram.WebApp;
        tg.expand();

        const uid = tg.initDataUnsafe?.user?.id || "user_test";
        const uRef = db.ref('users/' + uid);

        const prizes = [
            {n:"1—á VIP", i:"ü•à"}, {n:"3—á VIP", i:"ü•à"}, {n:"500 ‚≠ê", i:"‚≠ê", c:500}, 
            {n:"–ü–° 5", i:"üéÆ"}, {n:"100 ‚≠ê", i:"‚≠ê", c:100}
        ];

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        uRef.on('value', snap => {
            const d = snap.val() || { balance: 0, lvl: 1, xp: 0, name: "–ò–≥—Ä–æ–∫" };
            if(!snap.exists()) uRef.set(d);

            document.getElementById('h-bal').innerText = d.balance;
            document.getElementById('h-name').innerText = d.name;
            document.getElementById('h-lvl').innerText = "LVL " + d.lvl;
            
            // –ü—Ä–æ—Ñ–∏–ª—å
            document.getElementById('prof-lvl').innerText = "–£—Ä–æ–≤–µ–Ω—å " + d.lvl;
            let nextXp = d.lvl * 1000;
            document.getElementById('prof-xp-text').innerText = `${d.xp}/${nextXp} XP`;
            document.getElementById('xp-fill').style.width = (d.xp / nextXp * 100) + "%";

            // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
            let invH = '';
            if(d.inventory) {
                Object.values(d.inventory).reverse().forEach(v => {
                    invH += `<div class="card" style="padding:10px; margin-bottom:5px;">${v.icon} ${v.title}</div>`;
                });
            }
            document.getElementById('inv-list').innerHTML = invH || '<center style="opacity:0.3">–ü—É—Å—Ç–æ</center>';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–∫–∏ –±–æ–Ω—É—Å–∞
            const now = Date.now();
            const last = d.lastDaily || 0;
            if(now - last < 86400000) {
                document.getElementById('daily-btn').disabled = true;
                document.getElementById('daily-btn').innerText = "–ü–û–õ–£–ß–ï–ù–û";
            } else {
                document.getElementById('daily-btn').disabled = false;
                document.getElementById('daily-btn').innerText = "–ó–ê–ë–†–ê–¢–¨ 100 ‚≠ê";
            }
        });

        function showP(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById('p-' + id).classList.add('active');
            el.classList.add('active');
            if(id === 'top') loadTop();
            if(id === 'bans') loadBans();
        }

        // --- –õ–û–ì–ò–ö–ê –ö–ï–ô–°–ê ---
        function openCaseMenu() {
            document.getElementById('home-main').style.display = 'none';
            document.getElementById('case-ui').style.display = 'block';
        }
        function closeCaseMenu() {
            document.getElementById('home-main').style.display = 'block';
            document.getElementById('case-ui').style.display = 'none';
            document.getElementById('r-box').style.display = 'none';
        }

        function startSpin() {
            uRef.once('value', s => {
                const d = s.val();
                if(d.balance < 1000) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥!");

                const btn = document.getElementById('spin-btn');
                const box = document.getElementById('r-box');
                const tape = document.getElementById('tape');

                btn.disabled = true;
                box.style.display = 'block';
                tape.style.transition = 'none';
                tape.style.transform = 'translateX(0)';

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ª–µ–Ω—Ç—É
                let list = '';
                for(let i=0; i<40; i++) {
                    let p = prizes[Math.floor(Math.random()*prizes.length)];
                    list += `<div class="p-item"><div>${p.i}</div><b>${p.n}</b></div>`;
                }
                tape.innerHTML = list;

                let win = prizes[Math.floor(Math.random()*prizes.length)];
                setTimeout(() => {
                    tape.style.transition = 'transform 4s cubic-bezier(0.1, 0, 0.1, 1)';
                    tape.style.transform = 'translateX(-2500px)';
                }, 50);

                setTimeout(() => {
                    let newBal = d.balance - 1000 + (win.c || 0);
                    let newXp = d.xp + 150;
                    let updates = { balance: newBal, xp: newXp };
                    if(!win.c) uRef.child('inventory').push({title: win.n, icon: win.i});
                    uRef.update(updates);
                    db.ref('logs').push({name: d.name, prize: win.n});
                    tg.showAlert("–í—ã–ø–∞–ª–æ: " + win.n);
                    btn.disabled = false;
                }, 4500);
            });
        }

        // --- –û–°–¢–ê–õ–¨–ù–û–ï ---
        function claimDaily() {
            uRef.once('value', s => {
                const d = s.val();
                uRef.update({ balance: d.balance + 100, lastDaily: Date.now() });
                tg.showAlert("–ë–æ–Ω—É—Å –ø–æ–ª—É—á–µ–Ω!");
            });
        }

        function saveName() {
            const val = document.getElementById('name-input').value;
            if(val) uRef.update({ name: val }).then(() => tg.showAlert("–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!"));
        }

        function loadTop() {
            db.ref('users').orderByChild('balance').limitToLast(10).once('value', s => {
                let h = '';
                let a = [];
                s.forEach(c => { a.push(c.val()); });
                a.reverse().forEach((u, i) => {
                    h += `<div class="card" style="padding:10px; display:flex; justify-content:space-between;">
                        <span>#${i+1} ${u.name}</span><b>${u.balance} ‚≠ê</b>
                    </div>`;
                });
                document.getElementById('leader-list').innerHTML = h;
            });
        }

        function loadBans() {
            db.ref('bans').once('value', s => {
                let h = '';
                s.forEach(c => {
                    let b = c.val();
                    h += `<div class="card" style="border-left:4px solid var(--danger)">
                        <b>${b.name}</b><br><small>${b.reason}</small>
                    </div>`;
                });
                document.getElementById('ban-list').innerHTML = h || '<center>–ù–µ—Ç –±–∞–Ω–æ–≤</center>';
            });
        }

        db.ref('logs').limitToLast(5).on('value', s => {
            let h = '';
            s.forEach(l => { h = `<div>${l.val().name} ‚Äî ${l.val().prize}</div>` + h; });
            document.getElementById('global-logs').innerHTML = h;
        });
    </script>
</body>
</html>
