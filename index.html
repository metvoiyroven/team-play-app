<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TeamPlay Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        :root { --bg: #0b0e11; --card: #1c2127; --accent: #00d1ff; --danger: #ff4757; --text: #ffffff; --subtext: #94a3b8; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 10px 15px 120px 15px; overflow-x: hidden; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .balance-chip { background: rgba(0, 209, 255, 0.1); padding: 8px 15px; border-radius: 20px; color: var(--accent); font-weight: 800; border: 1px solid rgba(0, 209, 255, 0.2); }

        /* PAGES */
        .page { display: none; }
        .page.active { display: block; animation: fadePage 0.3s ease-out; }
        @keyframes fadePage { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .btn { background: var(--accent); color: #000; border: none; padding: 16px; border-radius: 16px; font-weight: 800; width: 100%; font-size: 15px; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        
        /* LOADER */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(0, 209, 255, 0.3); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* BAN CARD */
        .ban-card { border: 1px solid rgba(255, 71, 87, 0.3); background: linear-gradient(135deg, rgba(255, 71, 87, 0.05), transparent); }
        .ban-badge { background: var(--danger); color: white; font-size: 9px; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; font-weight: bold; }

        /* ROULETTE */
        .case-view { background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 25px; padding: 25px; text-align: center; border: 1px solid var(--accent); margin-bottom: 20px; }
        .roulette-container { height: 110px; background: #000; border-radius: 18px; position: relative; overflow: hidden; margin: 20px 0; display: none; border: 1px solid var(--accent); }
        .line { position: absolute; left: 50%; top: 0; bottom: 0; width: 3px; background: #ff4757; z-index: 10; box-shadow: 0 0 10px #ff4757; transform: translateX(-50%); }
        .tape { display: flex; position: absolute; left: 0; height: 100%; align-items: center; }
        .p-item { min-width: 100px; max-width: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center; border-right: 1px solid #1a1a1a; }
        .prize-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .grid-item { background: var(--card); padding: 10px; border-radius: 12px; text-align: center; font-size: 10px; border: 1px solid rgba(255,255,255,0.03); }

        /* PROFILE */
        .xp-container { background: #1c2127; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .xp-bar { background: var(--accent); height: 100%; width: 0%; transition: width 0.5s ease; }
        input[type="text"] { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 12px; margin: 10px 0; }

        /* NAV */
        .nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(11,14,17,0.96); display: flex; justify-content: space-around; padding: 12px 5px 30px 5px; backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.05); z-index: 1000; }
        .nav-link { color: #4b5563; text-decoration: none; text-align: center; font-size: 9px; font-weight: 600; min-width: 50px; }
        .nav-link.active { color: var(--accent); }
        .nav-link.active-danger { color: var(--danger); }
        .nav-link i { display: block; font-size: 20px; margin-bottom: 5px; font-style: normal; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="color:var(--subtext); font-size:12px;">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
    </div>

    <div class="header">
        <div><span id="h-lvl" style="color:var(--accent); font-weight:800; font-size:12px;">LVL 1</span><br><b id="h-name">–ó–∞–≥—Ä—É–∑–∫–∞...</b></div>
        <div class="balance-chip"><span id="h-bal">0</span> ‚≠ê</div>
    </div>

    <div id="p-home" class="page active">
        <div id="game-list">
            <div class="card" onclick="openCase()" style="display:flex; align-items:center; gap:15px; cursor:pointer;">
                <div style="font-size:32px;">üéÅ</div>
                <div><b>–ö–µ–π—Å –ü—Ä–∏–≤–∏–ª–µ–≥–∏–π</b><br><span style="color:var(--subtext); font-size:12px;">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–∑—ã</span></div>
            </div>
            <p style="font-size:11px; color:var(--subtext); text-transform:uppercase; margin-top:20px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–∏</p>
            <div id="global-logs" class="card" style="padding:10px; font-size:11px;"></div>
        </div>

        <div id="case-screen" style="display: none;">
            <div class="case-view">
                <div style="font-size: 50px;">üéÅ</div>
                <h2 style="margin:10px 0;">–ö–µ–π—Å –ü—Ä–∏–≤–∏–ª–µ–≥–∏–π</h2>
                <div id="r-box" class="roulette-container"><div class="line"></div><div id="tape" class="tape"></div></div>
                <button class="btn" id="spin-btn" onclick="spin()">–û–¢–ö–†–´–¢–¨ –ó–ê 1000 ‚≠ê</button>
            </div>
            <p style="font-size:11px; color:var(--subtext); text-transform:uppercase; margin-left:5px;">–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏–∑—ã</p>
            <div id="prize-grid" class="prize-grid"></div>
            <button class="btn" style="background:rgba(255,255,255,0.05); color:#fff; margin-top:20px;" onclick="closeCase()">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <div id="p-bonus" class="page">
        <h2 style="margin-bottom:20px;">–ë–æ–Ω—É—Å—ã ‚ö°</h2>
        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <div><b>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</b><br><span id="d-timer" style="color:var(--accent); font-size:12px">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span></div>
            <button id="d-btn" class="btn" style="width:auto; padding:10px 20px;" onclick="claimDaily()">–í–ó–Ø–¢–¨</button>
        </div>
        <p style="font-size:11px; color:var(--subtext); text-transform:uppercase; margin:20px 0 10px 5px;">–ó–∞–¥–∞–Ω–∏—è</p>
        <div class="card" id="task-vk-group" style="display:flex; justify-content:space-between; align-items:center;">
            <div><b>–ü–æ–¥–ø–∏—Å–∫–∞ –í–ö</b><br><span style="color:var(--accent); font-size:12px">+300 ‚≠ê</span></div>
            <button class="btn" style="width:auto; padding:10px 20px; background:#0077ff; color:#fff;" onclick="doTask('vk_group', 300, 'https://vk.com/clubXXXXXX')">–í–°–¢–£–ü–ò–¢–¨</button>
        </div>
        <div class="card" id="task-tg-group" style="display:flex; justify-content:space-between; align-items:center;">
            <div><b>–ì—Ä—É–ø–ø–∞ –≤ Telegram</b><br><span style="color:var(--accent); font-size:12px">+500 ‚≠ê</span></div>
            <button class="btn" style="width:auto; padding:10px 20px; background:#229ED9; color:#fff;" onclick="doTask('tg_group', 500, 'https://t.me/XXXXXX')">–ü–û–î–ü–ò–°–ê–¢–¨–°–Ø</button>
        </div>
        <div class="card" id="task-vk-post" style="display:flex; justify-content:space-between; align-items:center;">
            <div><b>–ü–æ—Å—Ç –≤ –í–ö</b><br><span style="color:var(--accent); font-size:12px">+1000 ‚≠ê</span></div>
            <button class="btn" style="width:auto; padding:10px 20px; background:#4c75a3; color:#fff;" onclick="doTask('vk_post', 1000, 'https://vk.com/share.php?url=https://t.me/your_bot')">–°–î–ï–õ–ê–¢–¨ –ü–û–°–¢</button>
        </div>
    </div>

    <div id="p-bans" class="page">
        <h2 style="margin-bottom:20px; color:var(--danger);">–ë–∞–Ω-–ª–∏—Å—Ç ‚õî</h2>
        <div id="ban-list-container">
            <center style="opacity:0.5; margin-top:50px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤...</center>
        </div>
    </div>

    <div id="p-profile" class="page">
        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
            <h2 style="margin:0;">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <b id="prof-lvl-txt" style="color:var(--accent)">LVL 1</b>
        </div>
        <div class="xp-container"><div id="xp-bar" class="xp-bar"></div></div>
        <div style="text-align:right; font-size:10px; color:var(--subtext); margin-bottom:20px;" id="xp-num">0 / 1000 XP</div>
        <div class="card">
            <b>–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞</b>
            <input type="text" id="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥...">
            <button class="btn" onclick="usePromo()">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</button>
        </div>
        <div class="card">
            <b>–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º</b>
            <input type="text" id="name-input" placeholder="–í–∞—à –Ω–∏–∫...">
            <button class="btn" style="background:rgba(255,255,255,0.05); color:#fff;" onclick="saveName()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
        <p style="font-size:11px; color:var(--subtext); text-transform:uppercase; margin-bottom:15px;">–ú–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</p>
        <div id="inv-list"></div>
    </div>

    <div id="p-top" class="page">
        <h2 style="margin-bottom:20px;">–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤ üèÜ</h2>
        <div id="leader-list"><center style="opacity:0.5; margin-top:50px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞...</center></div>
    </div>

    <nav class="nav">
        <a href="#" class="nav-link active" onclick="showP('home', this)"><i>üè†</i>–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="#" class="nav-link" onclick="showP('top', this)"><i>üèÜ</i>–¢–û–ü</a>
        <a href="#" class="nav-link" onclick="showP('bans', this)"><i>‚õî</i>–ë–∞–Ω—ã</a>
        <a href="#" class="nav-link" onclick="showP('bonus', this)"><i>‚ö°</i>–ë–æ–Ω—É—Å—ã</a>
        <a href="#" class="nav-link" onclick="showP('profile', this)"><i>üë§</i>–ü—Ä–æ—Ñ–∏–ª—å</a>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPx6V-_sE6k1_hnOkCvR8E1wOlsabVMbc",
            authDomain: "teamplay-9f75a.firebaseapp.com",
            databaseURL: "https://teamplay-9f75a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "teamplay-9f75a",
            storageBucket: "teamplay-9f75a.firebasestorage.app",
            messagingSenderId: "975773372092",
            appId: "1:975773372092:web:0a67ef446f6c8444318ab9"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase init success");
        } catch(e) {
            alert("–û—à–∏–±–∫–∞ Firebase: " + e.message);
        }

        const db = firebase.database();
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –ü–æ–ª—É—á–∞–µ–º ID. –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ —Ç–µ–ª–µ–≥–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID
        const uid = tg.initDataUnsafe?.user?.id || "user_" + Math.floor(Math.random() * 10000);
        const uRef = db.ref('users/' + uid);

        const prizes = [
            { n: "1—á STANDART", i: "ü•â", p: 10 }, { n: "1—á VIP", i: "ü•à", p: 6 },
            { n: "3—á STANDART", i: "ü•â", p: 4 }, { n: "3—á VIP", i: "ü•à", p: 3 },
            { n: "6—á STANDART", i: "ü•â", p: 2 }, { n: "6—á VIP", i: "ü•à", p: 1 },
            { n: "–ü–° 4 - 1—á", i: "üéÆ", p: 20 }, { n: "–ü–° 5 - 1—á", i: "üöÄ", p: 10 },
            { n: "500 ‚≠ê", i: "‚≠ê", p: 44, coin: 500 }
        ];

        // --- –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        uRef.once('value', snapshot => {
            if (!snapshot.exists()) {
                // –ï—Å–ª–∏ —é–∑–µ—Ä–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                uRef.set({
                    name: tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫ " + uid.toString().slice(-4),
                    balance: 0,
                    lvl: 1,
                    xp: 0
                }).then(() => hideLoader());
            } else {
                hideLoader();
            }
        }, error => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ø—Ä–∞–≤–∏–ª–∞ Firebase.");
            hideLoader();
        });

        function hideLoader() {
            const l = document.getElementById('loader');
            if(l) { l.style.opacity = '0'; setTimeout(() => l.remove(), 500); }
        }

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        uRef.on('value', snap => {
            const d = snap.val() || { balance: 0, lvl: 1, xp: 0, name: "..." };
            
            document.getElementById('h-bal').innerText = d.balance;
            document.getElementById('h-name').innerText = d.name;
            document.getElementById('h-lvl').innerText = `LVL ${d.lvl}`;
            document.getElementById('prof-lvl-txt').innerText = `LVL ${d.lvl}`;
            document.getElementById('name-input').value = d.name;
            
            const nextXp = d.lvl * 1000;
            document.getElementById('xp-bar').style.width = (d.xp / nextXp * 100) + "%";
            document.getElementById('xp-num').innerText = `${d.xp} / ${nextXp} XP`;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–¥–∞—á
            if(d.tasks) {
                if(d.tasks.vk_group) document.getElementById('task-vk-group').style.opacity = '0.5';
                if(d.tasks.tg_group) document.getElementById('task-tg-group').style.opacity = '0.5';
                if(d.tasks.vk_post) document.getElementById('task-vk-post').style.opacity = '0.5';
            }

            // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
            const inv = d.inventory ? Object.values(d.inventory).reverse() : [];
            document.getElementById('inv-list').innerHTML = inv.length ? inv.map(i => `
                <div class="card" style="padding:12px; margin-bottom:8px; display:flex; justify-content:space-between; font-size:13px;">
                    <b>${i.title}</b> <span>${i.icon}</span>
                </div>
            `).join('') : '<div style="opacity:0.5; text-align:center;">–ü—É—Å—Ç–æ</div>';
            
            // Level Up
            if(d.xp >= nextXp) uRef.update({ xp: 0, lvl: d.lvl + 1 });
        });

        // --- –õ–û–ì–ò–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
        function showP(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => {
                n.classList.remove('active');
                n.classList.remove('active-danger');
            });
            document.getElementById('p-' + id).classList.add('active');
            
            if(id === 'bans') {
                el.classList.add('active-danger');
                loadBans();
            } else {
                el.classList.add('active');
            }
            
            if(id === 'home') closeCase();
            if(id === 'top') loadTop();
            tg.HapticFeedback.impactOccurred('light');
        }

        // --- –¢–û–ü –ò–ì–†–û–ö–û–í (–ò–°–ü–†–ê–í–õ–ï–ù–û) ---
        function loadTop() {
            db.ref('users').orderByChild('balance').limitToLast(10).once('value', snapshot => {
                const list = document.getElementById('leader-list');
                if (!snapshot.exists()) {
                    list.innerHTML = '<center style="opacity:0.5; margin-top:20px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</center>';
                    return;
                }

                let players = [];
                snapshot.forEach(child => {
                    const val = child.val();
                    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                    if(val) players.push(val);
                });

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
                list.innerHTML = players.reverse().map((u, i) => `
                    <div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:14px; color:${i<3 ? 'gold' : '#fff'}">#${i+1}</span>
                            <span>${u.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</span>
                        </div>
                        <b>${u.balance || 0} ‚≠ê</b>
                    </div>
                `).join('');
            });
        }

        // --- –ë–ê–ù –õ–ò–°–¢ (–ò–°–ü–†–ê–í–õ–ï–ù–û) ---
        function loadBans() {
            db.ref('bans').once('value', snapshot => {
                const container = document.getElementById('ban-list-container');
                if(!snapshot.exists()) {
                    container.innerHTML = '<center style="opacity:0.5; margin-top:50px;">üö´ –ù–∞—Ä—É—à–∏—Ç–µ–ª–µ–π –Ω–µ—Ç. –í—Å–µ —á–∏—Å—Ç—ã!</center>';
                    return;
                }

                let html = '';
                snapshot.forEach(child => {
                    const b = child.val();
                    html += `
                        <div class="card ban-card">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <b style="font-size:16px;">${b.name || '–ò–≥—Ä–æ–∫'}</b>
                                <span class="ban-badge">–ó–ê–ë–ê–ù–ï–ù</span>
                            </div>
                            <div style="color:var(--danger); font-size:13px; margin-top:5px;">‚ö† ${b.reason || '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª'}</div>
                            <div style="font-size:11px; color:var(--subtext); margin-top:5px;">–°—Ä–æ–∫: ${b.expires || '–ù–∞–≤—Å–µ–≥–¥–∞'}</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            });
        }

        // --- –†–£–õ–ï–¢–ö–ê ---
        function openCase() {
            document.getElementById('game-list').style.display = 'none';
            document.getElementById('case-screen').style.display = 'block';
            const grid = document.getElementById('prize-grid');
            grid.innerHTML = prizes.map(p => `<div class="grid-item"><div style="font-size:24px;">${p.i}</div><b>${p.n}</b></div>`).join('');
        }
        function closeCase() {
            document.getElementById('game-list').style.display = 'block';
            document.getElementById('case-screen').style.display = 'none';
        }
        function spin() {
            uRef.once('value', s => {
                const d = s.val() || { balance: 0 };
                if(d.balance < 1000) return tg.showAlert("–ù—É–∂–Ω–æ 1000 ‚≠ê");
                const box = document.getElementById('r-box');
                const tape = document.getElementById('tape');
                const btn = document.getElementById('spin-btn');
                btn.disabled = true;
                box.style.display = 'block';
                tape.style.transition = 'none';
                tape.style.transform = 'translateX(0)';
                let html = '';
                for(let i=0; i<65; i++) {
                    const r = prizes[Math.floor(Math.random()*prizes.length)];
                    html += `<div class="p-item"><div style="font-size:24px">${r.i}</div><b style="font-size:9px">${r.n}</b></div>`;
                }
                tape.innerHTML = html;
                const winIdx = 55;
                const win = prizes[Math.floor(Math.random()*prizes.length)];
                tape.chil
